# Архитектура системы

## Обзор

Система управления скидками для детского магазина построена по принципу разделения на слои:

1. **Presentation Layer** (Frontend) - React приложение
2. **API Layer** (Backend) - FastAPI REST API
3. **Business Logic Layer** - Сервисы с бизнес-логикой
4. **Data Access Layer** - SQLAlchemy ORM + PostgreSQL

## Модули системы

### 1. Клиентская база (Customers)

**Модели:**
- `Customer` - профиль клиента
- `PurchaseHistory` - история покупок

**Функционал:**
- Регистрация и управление клиентами
- История покупок
- Статистика по клиенту (общая сумма, количество визитов)

### 2. Бонусный баланс (Bonuses)

**Модели:**
- `BonusBalance` - текущий баланс клиента
- `BonusTransaction` - транзакции по бонусам

**Функционал:**
- Начисление бонусов (1% от суммы покупки)
- Списание бонусов
- История транзакций
- Автоматическое начисление при покупке

### 3. Расчёт скидок (Discounts)

**Модели:**
- `DiscountRule` - правила применения скидок
- `DiscountApplication` - история применения скидок

**Типы скидок:**
- Процентные (`percentage`)
- Фиксированная сумма (`fixed_amount`)
- Множитель бонусов (`bonus_multiplier`)

**Условия применения:**
- Минимальная сумма покупки
- Максимальная сумма скидки
- Ограничение по магазинам
- Ограничение по категориям товаров
- Ограничение по сегментам клиентов
- Ограничение по количеству использований

### 4. Кассовый интегратор (POS)

**Функционал:**
- Обработка покупки через кассу
- Автоматический расчёт скидок
- Применение бонусов
- Начисление новых бонусов
- Создание записи о покупке

**Процесс обработки покупки:**
1. Расчёт доступных скидок
2. Применение скидок к сумме
3. Списание бонусов (если указано)
4. Создание записи о покупке
5. Начисление новых бонусов
6. Отправка уведомления

### 5. Аналитика (Analytics)

**Модели:**
- `CustomerSegment` - сегменты клиентов
- `Campaign` - маркетинговые кампании

**Функционал:**
- Автоматическая сегментация клиентов:
  - `new` - новые клиенты
  - `one_time` - одноразовые покупки
  - `regular` - постоянные клиенты (5+ визитов)
  - `vip` - VIP клиенты (10+ визитов, 10000+₽)
- Статистика по выручке, скидкам, бонусам
- Эффективность скидок
- Анализ по сегментам

### 6. Уведомления (Notifications)

**Модели:**
- `Notification` - уведомления

**Типы уведомлений:**
- Email
- SMS
- Push-уведомления

**Функционал:**
- Отправка уведомлений о начислении бонусов
- История уведомлений
- Статусы доставки

### 7. Магазины (Stores)

**Модели:**
- `Store` - информация о магазинах

**Функционал:**
- Управление филиалами
- Привязка покупок к магазинам

## Потоки данных

### Обработка покупки

```
Клиент → POS → API
                ↓
        1. Расчёт скидок (DiscountService)
                ↓
        2. Списание бонусов (BonusService)
                ↓
        3. Создание покупки (CustomerService)
                ↓
        4. Применение скидок (DiscountService)
                ↓
        5. Начисление бонусов (BonusService)
                ↓
        6. Отправка уведомления (NotificationService)
                ↓
        7. Обновление статистики клиента
```

### Сегментация клиентов

```
Аналитика → AnalyticsService
                ↓
        Анализ данных клиента
                ↓
        Определение сегмента
                ↓
        Сохранение в CustomerSegment
```

## API Endpoints

### Клиенты
- `GET /api/customers/` - список
- `POST /api/customers/` - создание
- `GET /api/customers/{id}` - детали
- `PUT /api/customers/{id}` - обновление
- `GET /api/customers/{id}/purchases` - история

### Бонусы
- `GET /api/bonuses/{id}/balance` - баланс
- `POST /api/bonuses/{id}/earn` - начисление
- `POST /api/bonuses/{id}/spend` - списание
- `GET /api/bonuses/{id}/transactions` - транзакции

### Скидки
- `GET /api/discounts/rules` - список правил
- `POST /api/discounts/rules` - создание
- `PUT /api/discounts/rules/{id}` - обновление
- `POST /api/discounts/calculate` - расчёт

### Касса
- `POST /api/pos/process-purchase` - обработка покупки
- `GET /api/pos/customer/{id}/available-discounts` - доступные скидки

### Аналитика
- `GET /api/analytics/summary` - сводка
- `POST /api/analytics/` - детальная аналитика
- `POST /api/analytics/segments/update` - обновление сегментов

## База данных

### Основные таблицы

- `customers` - клиенты
- `purchase_history` - покупки
- `bonus_balances` - балансы бонусов
- `bonus_transactions` - транзакции бонусов
- `discount_rules` - правила скидок
- `discount_applications` - применения скидок
- `stores` - магазины
- `customer_segments` - сегменты
- `campaigns` - кампании
- `notifications` - уведомления

### Связи

- Customer → PurchaseHistory (1:N)
- Customer → BonusBalance (1:1)
- Customer → CustomerSegment (1:N)
- PurchaseHistory → DiscountApplication (1:N)
- DiscountRule → DiscountApplication (1:N)
- Store → PurchaseHistory (1:N)

## Безопасность

- Валидация данных через Pydantic
- Защита от SQL-инъекций через SQLAlchemy
- CORS настройки для frontend
- Валидация бизнес-правил в сервисах

## Масштабируемость

- Разделение на модули для горизонтального масштабирования
- Использование индексов в БД для производительности
- Возможность добавления кэширования (Redis)
- Асинхронная обработка уведомлений (Celery)

## Расширяемость

Система легко расширяется:
- Новые типы скидок
- Дополнительные условия применения
- Новые каналы уведомлений
- Дополнительные метрики аналитики
- Интеграция с внешними системами

